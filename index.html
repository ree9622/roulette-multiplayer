<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <title>Marble Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="assets/manifest.json">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://lazygyu.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="lazygyu.github.io">
  <meta property="og:type" content="website">

  <link rel='stylesheet' href='assets/style.scss' />
</head>
<body>
<script type="module" src="./src/index.ts"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('js', new Date());
  gtag('config', 'G-5899C1DJM0');

  function getNames() {
    const value = document.querySelector('#in_names').value.trim();
    return value.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
  }

  function parseName(nameStr) {
    const weightRegex = /(\/\d+)/;
    const countRegex = /(\*\d+)/;
    const hasWeight = weightRegex.test(nameStr);
    const hasCount = countRegex.test(nameStr);
    const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
    const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
    const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
    return {
      name,
      weight,
      count,
    };
  }

  function getReady() {
    const names = getNames();
    window.roulette.setMarbles(names);
    ready = names.length > 0;
    localStorage.setItem('mbr_names', names.join(','));
    switch (winnerType) {
      case 'first':
        setWinnerRank(1);
        break;
      case 'last':
        const total = window.roulette.getCount();
        setWinnerRank(total);
        break;
    }
  }

  function setWinnerRank(rank) {
    document.querySelector('#in_winningRank').value = rank;
    window.options.winningRank = rank - 1;
    window.roulette.setWinningRank(window.options.winningRank);

    if (winnerType === 'first') {
      document.querySelector('.btn-first-winner').classList.toggle('active', true);
      document.querySelector('.btn-last-winner').classList.toggle('active', false);
      document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'last') {
      document.querySelector('.btn-first-winner').classList.toggle('active', false);
      document.querySelector('.btn-last-winner').classList.toggle('active', true);
      document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'custom') {
      document.querySelector('.btn-first-winner').classList.toggle('active', false);
      document.querySelector('.btn-last-winner').classList.toggle('active', false);
      document.querySelector('#in_winningRank').classList.toggle('active', true);
    }
  }


  let ready = false;
  let winnerType = 'first';

  document.addEventListener('DOMContentLoaded', () => {
    initialize();
  });

  // 2025-11-14: ì„±ëŠ¥ ìµœì í™” - í´ë§ ë°©ì‹ì—ì„œ Promise ê¸°ë°˜ ëŒ€ê¸°ë¡œ ë³€ê²½
  // ê¸°ì¡´: 100msë§ˆë‹¤ í´ë§í•˜ì—¬ 1,600íšŒ ì´ìƒ ë°˜ë³µ â†’ CPU ë‚­ë¹„
  // ê°œì„ : Promise.race()ë¡œ ìµœëŒ€ 30ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
  async function initialize() {
    const MAX_WAIT_TIME = 30000; // 30ì´ˆ
    const CHECK_INTERVAL = 100;

    try {
      await Promise.race([
        // Roulette ë¡œë”© ëŒ€ê¸°
        new Promise((resolve, reject) => {
          const checkReady = () => {
            if (window.roulette && window.roulette.isReady) {
              resolve();
            } else {
              setTimeout(checkReady, CHECK_INTERVAL);
            }
          };
          checkReady();
        }),
        // íƒ€ì„ì•„ì›ƒ
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Roulette initialization timeout')), MAX_WAIT_TIME)
        )
      ]);
    } catch (error) {
      console.error('Failed to initialize roulette:', error);
      alert('ë£°ë › ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    console.log('initializing start');

    const savedNames = localStorage.getItem('mbr_names');
    if (savedNames) {
      document.querySelector('#in_names').value = savedNames;
    }
    document.querySelector('#in_names').addEventListener('input', () => {
      getReady();
    });

    document.querySelector('#in_names').addEventListener('blur', () => {
      const nameSource = getNames();
      const nameSet = new Set();
      const nameCounts = {};
      nameSource.forEach(nameSrc => {
        const name = parseName(nameSrc);
        const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
        if (!nameSet.has(key)) {
          nameSet.add(key);
          nameCounts[key] = 0;
        }
        nameCounts[key] += name.count;
      });
      const result = [];
      Object.keys(nameCounts).forEach(key => {
        if (nameCounts[key] > 1) {
          result.push(`${key}*${nameCounts[key]}`);
        } else {
          result.push(key);
        }
      });

      const oldValue = document.querySelector('#in_names').value;
      const newValue = result.join(',');

      if (oldValue !== newValue) {
        document.querySelector('#in_names').value = newValue;
        getReady();
      }
    });

    document.querySelector('#btnShuffle').addEventListener('click', () => {
      getReady();
    });

    // ë¹¨ë¦¬ê°ê¸° ìƒíƒœ ê°ì‹œ (ë©€í‹°í”Œë ˆì´ì–´ìš©)
    let lastFastForwardState = false;
    setInterval(() => {
      if (window.multiplayerUI && window.multiplayerUI.getRoomManager().getRoomId()) {
        const roomManager = window.multiplayerUI.getRoomManager();
        const gameSync = window.multiplayerUI.getGameSync();

        if (roomManager.getIsHost()) {
          const fastForwarder = window.roulette.getFastForwarder();
          const currentState = fastForwarder.getEnabled();

          if (currentState !== lastFastForwardState) {
            lastFastForwardState = currentState;
            gameSync.setFastForward(currentState);
          }
        }
      }
    }, 100);

    document.querySelector('#btnStart').addEventListener('click', () => {
      if (!ready) return;
      gtag && gtag('event', 'start', {
        'event_category': 'roulette',
        'event_label': 'start',
        'value': window.roulette.getCount(),
      });

      // ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œì¸ ê²½ìš° GameSyncë¥¼ í†µí•´ ì‹œì‘
      if (window.multiplayerUI && window.multiplayerUI.getRoomManager().getRoomId()) {
        const roomManager = window.multiplayerUI.getRoomManager();
        const gameSync = window.multiplayerUI.getGameSync();

        // í˜¸ìŠ¤íŠ¸ë§Œ ê²Œì„ ì‹œì‘ ê°€ëŠ¥
        if (roomManager.getIsHost()) {
          // ëª¨ë“  ì°¸ê°€ìê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if (!roomManager.areAllPlayersReady()) {
            alert('ëª¨ë“  ì°¸ê°€ìê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
            return;
          }

          // ê²Œì„ ì„¤ì • ìˆ˜ì§‘ - ì°¸ê°€ì ì´ë¦„ë“¤ì„ êµ¬ìŠ¬ë¡œ ì‚¬ìš©
          const players = roomManager.getPlayers();
          const names = players.map(player => player.name);
          const mapIndex = parseInt(document.querySelector('#sltMap').value);
          const winnerRank = window.options.winningRank;

          console.log('[MultiplayerMode] ê²Œì„ ì‹œì‘:', names, mapIndex, winnerRank);

          // GameSyncë¥¼ í†µí•´ ê²Œì„ ì‹œì‘ (ëª¨ë“  ì°¸ê°€ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸)
          // GameSyncê°€ ì•Œì•„ì„œ í˜¸ìŠ¤íŠ¸ë„ ê²Œì„ì„ ì‹œì‘í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” return
          gameSync.startGame(names, mapIndex, winnerRank);

          // UI ìˆ¨ê¸°ê¸°ëŠ” GameSyncì˜ gameStart ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨
          return;
        } else {
          alert('í˜¸ìŠ¤íŠ¸ë§Œ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
      }

      // ì‹±ê¸€í”Œë ˆì´ì–´ ëª¨ë“œ
      window.roulette.start();
      document.querySelector('#settings').classList.add('hide');
    });

    document.querySelector('#chkAutoRecording').addEventListener('change', (e) => {
      window.options.autoRecording = e.target.matches(':checked');
      window.roulette.setAutoRecording(window.options.autoRecording);
    });

    document.querySelector('#chkSkill').addEventListener('change', (e) => {
      window.options.useSkills = e.target.matches(':checked');
      window.roulette.setWinningRank(window.options.winningRank);
    });

    document.querySelector('#in_winningRank').addEventListener('change', (e) => {
      const v = parseInt(e.target.value, 10);
      winnerType = 'custom';
      setWinnerRank(isNaN(v) ? 0 : v);
    });

    document.querySelector('.btn-last-winner').addEventListener('click', () => {
      const total = window.roulette.getCount();
      winnerType = 'last';
      setWinnerRank(total);
    });
    document.querySelector('.btn-first-winner').addEventListener('click', () => {
      winnerType = 'first';
      setWinnerRank(1);
    });

    document.querySelector('#btnShake').addEventListener('click', () => {
      window.roulette.shake();
      gtag('event', 'shake', {
        'event_category': 'roulette',
        'event_label': 'shake',
        'value': 1,
      });
    });

    window.roulette.addEventListener('goal', (e) => {
      // ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œ ì²´í¬
      if (window.multiplayerUI && window.multiplayerUI.getRoomManager().getRoomId()) {
        const roomManager = window.multiplayerUI.getRoomManager();
        const gameSync = window.multiplayerUI.getGameSync();
        const fromHost = e.detail.fromHost || false;

        if (roomManager.getIsHost()) {
          // í˜¸ìŠ¤íŠ¸ë§Œ ê²Œì„ ì¢…ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
          const winner = e.detail.winner;
          const allPlayers = roomManager.getPlayers().map(p => p.name);

          console.log('[Multiplayer] í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ ì¢…ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸:', winner);
          gameSync.endGame([winner], allPlayers);

          // í˜¸ìŠ¤íŠ¸ UI ì²˜ë¦¬
          ready = false;
          setTimeout(() => {
            document.querySelector('#settings').classList.remove('hide');
          }, 3000);

        } else if (fromHost) {
          // ì°¸ê°€ìê°€ í˜¸ìŠ¤íŠ¸ë¡œë¶€í„° ë°›ì€ ê²°ê³¼ ì²˜ë¦¬
          console.log('[Multiplayer] ì°¸ê°€ì - í˜¸ìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì‹ :', e.detail.winner);

          // ì°¸ê°€ì UI ì²˜ë¦¬
          ready = false;
          setTimeout(() => {
            document.querySelector('#settings').classList.remove('hide');
          }, 3000);

        } else {
          // ì°¸ê°€ìì˜ ìì²´ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ëŠ” ë¬´ì‹œ
          console.log('[Multiplayer] ì°¸ê°€ì - ìì²´ ê²°ê³¼ ë¬´ì‹œ (í˜¸ìŠ¤íŠ¸ ê²°ê³¼ ëŒ€ê¸° ì¤‘)');
          return;
        }
      } else {
        // ì‹±ê¸€í”Œë ˆì´ì–´ ëª¨ë“œ
        ready = false;
        setTimeout(() => {
          document.querySelector('#settings').classList.remove('hide');
        }, 3000);
      }
    });
    window.roulette.addEventListener('shakeAvailableChanged', (e) => {
      document.querySelector('#inGame').classList.toggle('hide', !e.detail);
    });
    window.roulette.addEventListener('message', (e) => {
      simpleToast(e.detail);
    });

    document.querySelector('#btnShuffle').click();

    const maps = window.roulette.getMaps();
    const mapSelector = document.querySelector('#sltMap');
    maps.forEach((map) => {
      const option = document.createElement('option');
      option.value = map.index;
      option.innerHTML = map.title;
      option.setAttribute('data-trans', '');
      window.translateElement(option);
      mapSelector.append(option);
    });
    mapSelector.addEventListener('change', (e) => {
      const index = e.target.value;
      window.roulette.setMap(index);
    });

    function simpleToast(msg) {
      const toast = document.createElement('div');
      toast.classList.add('toast');
      toast.innerHTML = msg;

      if (window.translateElement) {
        console.log('try to translate');
        window.translateElement(toast);
      }

      document.body.appendChild(toast);
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 1200);
    }
  }
</script>
<div id="settings" class="settings">
  <div class="right">
    <div class="row">
      <label>
        <i class="icon map"></i>
        <span data-trans>Map</span>
      </label>
      <select id="sltMap"></select>
    </div>
    <div class="row">
      <label>
        <i class="icon record"></i>
        <span data-trans>Recording</span>
      </label>
      <input type="checkbox" id="chkAutoRecording" />
    </div>
    <div class="row">
      <label>
        <i class="icon trophy"></i>
        <span data-trans>The winner is</span>
      </label>
      <div class="btn-group">
        <button class="btn-winner btn-first-winner active" data-trans>First</button>
        <button class="btn-winner btn-last-winner" data-trans>Last</button>
        <input type="number" id="in_winningRank" value="1" min="1" />
      </div>
    </div>
    <div class="row">
      <label>
        <i class="icon bomb"></i>
        <span data-trans>Using skills</span>
      </label>
      <input type="checkbox" id="chkSkill" checked />
    </div>
  </div>
  <div class="left">
    <h3 data-trans>Enter names below</h3>
    <textarea id="in_names" placeholder="Input names separated by commas or line feed here" data-trans="placeholder">ì§±êµ¬*5, ì§±ì•„*10, ë´‰ë¯¸ì„ *3</textarea>
    <div class="actions">
      <button id="mp-create-room-btn" class="mp-btn">
        <span>ğŸ  ë°© ë§Œë“¤ê¸°</span>
      </button>
      <button id="mp-join-room-btn" class="mp-btn">
        <span>ğŸšª ë°© ì°¸ê°€í•˜ê¸°</span>
      </button>
      <div class="sep"></div>
      <button id="btnShuffle">
        <i class="icon shuffle"></i>
        <span data-trans>Shuffle</span>
      </button>
      <button id="btnStart" id="start">
        <i class="icon play"></i>
        <span data-trans>Start</span>
      </button>
    </div>
  </div>
</div>
<div id="inGame" class="settings hide">
  <button id="btnShake" data-trans>Shake!</button>
</div>
<!-- ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë‹¬ -->
<div id="mp-modal" class="mp-modal" style="display: none;">
  <div class="mp-modal-content">
    <h2 id="mp-modal-title"></h2>
    <div id="mp-modal-content"></div>
  </div>
</div>

<!-- ë©€í‹°í”Œë ˆì´ì–´ ë£¸ íŒ¨ë„ -->
<div id="mp-room-panel" class="mp-room-panel" style="display: none;">
  <div class="mp-room-header">
    <h3>ğŸ® ë©€í‹°í”Œë ˆì´ì–´</h3>
    <div class="mp-room-code-container">
      <span>ë°© ì½”ë“œ:</span>
      <span id="mp-room-code-display" class="mp-room-code"></span>
      <button id="mp-copy-room-code" class="mp-btn-copy">ğŸ“‹ ë³µì‚¬</button>
    </div>
  </div>
  <div class="mp-player-list-container">
    <h4>ì°¸ê°€ì ëª©ë¡</h4>
    <div id="mp-player-list" class="mp-player-list"></div>
  </div>
  <div class="mp-room-actions">
    <button id="mp-change-name-btn" class="mp-btn-secondary" style="display: inline-block;">ì´ë¦„ ë³€ê²½</button>
    <button id="mp-ready-btn" class="mp-btn-primary" style="display: none;">ì¤€ë¹„</button>
    <button id="mp-leave-room-btn" class="mp-btn-secondary" style="display: none;">ë‚˜ê°€ê¸°</button>
  </div>
</div>
<div class="copyright">&copy; 2022-2025.<a href="https://lazygyu.net" target="_blank">lazygyu</a> <span data-trans>This program is freeware and may be used freely anywhere, including in broadcasts and videos.</span>
</div>
</body>
</html>
